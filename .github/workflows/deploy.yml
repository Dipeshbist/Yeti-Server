name: Build & Deploy Yeti Backend (Dockerized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Run on Server
    runs-on: self-hosted   # Ubuntu runner with Docker + Compose installed

    steps:
      # 1ï¸âƒ£ Checkout latest code
      - name: Checkout code
        uses: actions/checkout@v4

      # 4ï¸âƒ£ Recreate .env file from GitHub Secrets
      - name: Create .env file from GitHub Secret
        run: |
          echo "${{ secrets.ENV }}" > .env
          echo "âœ… .env file created with environment variables"

      # 2ï¸âƒ£ Stop and remove any existing stack (if running)
      - name: Stop existing containers
        run: |
          echo "ğŸ§¹ Stopping old containers..."
          docker compose down || true

      # 3ï¸âƒ£ Rebuild Docker images (this will rebuild yeti-backend and pull others)
      - name: Build Docker Compose services
        run: |
          echo "ğŸ—ï¸ Building updated Docker images..."
          docker compose build --no-cache

      

      # 5ï¸âƒ£ Start all services (db, yeti-backend, tb-postgres, thingsboard-ce)
      - name: Start Docker Compose stack
        run: |
          echo "ğŸš€ Starting Docker Compose stack..."
          docker compose up -d

      # 6ï¸âƒ£ Health check for Yeti Backend
      - name: Verify deployment
        run: |
          echo "ğŸ©º Checking Yeti Backend health..."
          docker ps
          sleep 8
          curl -f http://localhost:8000 || echo "âš ï¸ Backend health check failed, but container started"

      # 7ï¸âƒ£ Optional cleanup of unused images
      - name: Cleanup old images
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up old Docker images..."
          docker image prune -f || true
