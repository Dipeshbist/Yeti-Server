name: Build & Deploy Yeti Backend (Dockerized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    name: Build & Run on Server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file from GitHub Secret
        working-directory: /home/ubuntu/yeti/yeti-backend/actions-runner/_work/Yeti-Server/Yeti-Server
        run: |
          echo "${{ secrets.ENV }}" > .env
          echo "âœ… .env file created with environment variables"

      - name: Stop existing containers
        working-directory: /home/ubuntu/yeti/yeti-backend/actions-runner/_work/Yeti-Server/Yeti-Server
        run: |
          echo "ğŸ§¹ Cleaning up old containers..."
          docker compose stop yeti-backend || true
          docker compose rm -f yeti-backend || true


      - name: Build Docker Compose services
        working-directory: /home/ubuntu/yeti/yeti-backend/actions-runner/_work/Yeti-Server/Yeti-Server
        run: |
          echo "ğŸ—ï¸ Building updated Docker images..."
          docker compose build

      - name: Start Docker Compose stack
        working-directory: /home/ubuntu/yeti/yeti-backend/actions-runner/_work/Yeti-Server/Yeti-Server
        run: |
          echo "ğŸš€ Starting stack (Yeti + ThingsBoard)..."
          docker compose up -d

      - name: Wait for PostgreSQL
        run: |
          echo "â³ Waiting for PostgreSQL to initialize..."
          sleep 45
          docker ps

      - name: Initialize ThingsBoard Database (only first deployment)
        working-directory: /home/ubuntu/yeti/yeti-backend/actions-runner/_work/Yeti-Server/Yeti-Server
        run: |
          if [ ! -d "/home/ubuntu/yeti/things-db-data/base" ]; then
            echo "ğŸ§© Running initial ThingsBoard installation..."
            docker compose run --rm -e INSTALL_TB=true -e LOAD_DEMO=true thingsboard-ce
          else
            echo "âœ… ThingsBoard database already exists â€” skipping installation."
          fi

      - name: Verify Deployment
        run: |
          echo "ğŸ©º Checking containers..."
          docker ps
          echo "ğŸ” Checking Yeti backend..."
          curl -f http://localhost:8000 || echo "âš ï¸ Backend not responding yet"
          echo "ğŸŒ Checking ThingsBoard..."
          curl -f http://localhost:8080 || echo "âš ï¸ ThingsBoard UI check failed"

      - name: Show Docker Logs (on failure)
        if: failure()
        run: |
          echo "ğŸ“œ Showing recent logs for debugging..."
          docker compose logs --tail=50
