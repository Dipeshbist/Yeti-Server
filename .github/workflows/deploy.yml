name: Build & Deploy Yeti Backend (Dockerized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Run on Server
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file from GitHub Secret
        run: |
          echo "${{ secrets.ENV }}" > .env
          echo "âœ… .env file created with environment variables"

      - name: Verify certificate files exist
        run: |
          echo "ğŸ” Checking certificates..."
          ls -la /home/ubuntu/yeti/thingsboard/Certificates/ || echo "âš ï¸ Certificate directory not found!"
          ls -la /home/ubuntu/yeti/thingsboard/config/ || echo "âš ï¸ Config directory not found!"

      - name: Stop existing containers
        timeout-minutes: 10
        run: |
          echo "ğŸ§¹ Cleaning up old containers..."
          docker compose down --timeout 60 || true

      - name: Build Docker Compose services
        run: |
          echo "ğŸ—ï¸ Building updated Docker images..."
          docker compose build

      - name: Start Docker Compose stack
        run: |
          echo "ğŸš€ Starting stack (Yeti + ThingsBoard)..."
          docker compose up -d

      - name: Wait for services to initialize
        run: |
          echo "â³ Waiting for services to start..."
          sleep 30
          docker ps

      - name: Initialize ThingsBoard Database (if needed)
        run: |
          echo "ğŸ§© Checking if ThingsBoard needs initialization..."
          # Check if database tables exist
          if docker compose exec -T tb-postgres psql -U postgres -d thingsboard -c "\dt" 2>/dev/null | grep -q "device"; then
            echo "âœ… ThingsBoard already initialized, skipping..."
          else
            echo "ğŸ”§ Running ThingsBoard installation..."
            docker compose run --rm -e INSTALL_TB=true -e LOAD_DEMO=true thingsboard-ce
            sleep 10
            docker compose restart thingsboard-ce
            echo "âœ… ThingsBoard initialized successfully"
          fi

      - name: Check ThingsBoard logs for errors
        run: |
          echo "ğŸ“‹ Checking ThingsBoard logs..."
          docker compose logs --tail=50 thingsboard-ce

      - name: Verify Deployment
        run: |
          echo "ğŸ©º Final health checks..."
          docker ps
          echo ""
          echo "ğŸ” Checking Yeti backend..."
          curl -f http://localhost:8000 || echo "âš ï¸ Backend not responding yet"
          echo ""
          echo "ğŸŒ Checking ThingsBoard..."
          sleep 10
          curl -f http://localhost:8080 || echo "âš ï¸ ThingsBoard UI check failed (may need more time)"