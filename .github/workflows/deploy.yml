name: Build & Deploy Yeti Backend (Dockerized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Run on Server
    runs-on: self-hosted   # Ubuntu runner with Docker installed

    steps:
      # 1ï¸âƒ£ Checkout latest code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Build Docker image for Yeti Backend
      - name: Build Docker image
        run: |
          docker build -t yeti-backend:latest -f Dockerfile .

      # 3ï¸âƒ£ Stop & remove old container (if running)
      - name: Stop old container
        run: |
          if [ "$(docker ps -aq -f name=yeti-backend)" ]; then
            echo "ğŸ›‘ Stopping old container..."
            docker stop yeti-backend || true
            docker rm yeti-backend || true
          fi

      # 4ï¸âƒ£ Create .env file dynamically from GitHub Secret
      - name: Create .env file from GitHub Secret
        run: |
          echo "${{ secrets.ENV }}" > .env
          echo "âœ… .env file created with environment variables"

      # 5ï¸âƒ£ Run the new container using the .env file
      - name: Run updated container
        run: |
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name yeti-backend \
            --restart=always \
            -p 8000:8000 \
            --env-file .env \
            yeti-backend:latest

      # 6ï¸âƒ£ Health check
      - name: Verify deployment
        run: |
          echo "ğŸ©º Checking status..."
          docker ps
          sleep 8
          curl -f http://localhost:8000 || echo "âš ï¸ Health check failed, but container started"
